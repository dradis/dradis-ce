<% cache ['tags-table', @all_columns, @tags] do %>
  <table class="table table-striped mb-0"
    data-behavior="dradis-datatable"
    data-default-columns="<%= @default_columns.to_json %>"
    data-item-name="tags"
    data-local-storage-key="project.ce.<%= dom_id(current_project) %>.tags_datatable"
    data-reorderable="true">
    <thead>
      <tr>
        <% @all_columns.each do |column| %>

          <%= content_tag :th, 
            class: class_names('no-sort', 'd-none': column == 'Sort rank'), 
            data: { column_visible: !['Sort rank', 'Sort handle'].include?(column) } do %>
            <% if ['Sort rank', 'Sort handle'].include?(column) %>
              <%= content_tag :span, column, class: 'visually-hidden' %>
            <% else %>
              <%= column %>
            <% end %>
          <% end %>
        <% end %>
        <th class="no-sort" data-column-visible="false"><span class="visually-hidden">Actions</span></th>
      </tr>
    </thead>
    <tbody>
      <% @tags.each_with_index do |tag, sort_rank| %>
        <% cache [tag, @all_columns, 'tags-table'] do %>
          <tr id="tag-<%= tag.id %>">
            <% @all_columns.each do |column| %>
              <%
              sort, display =
              case column
              when 'Sort rank'
                [sort_rank, sort_rank]
              when 'Sort handle'
                ['Change tag order', content_tag(:i, nil, class: 'fa-solid fa-reorder') + content_tag(:span, 'Change tag order', class: 'visually-hidden')]
              when 'Name'
                [
                  tag.display_name,
                  content_tag(:span, class: 'tag', style: "color: #{tag.color}") do
                    content_tag(:i, nil, class: 'fa-solid fa-tag fa-fw me-1') + tag.display_name
                  end
                ]
              when 'Color'
                [tag.color, content_tag(:span, tag.color, style:  "color: #{tag.color}")]
              when 'Created'
                [tag.created_at.to_i, local_time_ago(tag.created_at)]
              when 'Updated'
                [tag.updated_at.to_i, local_time_ago(tag.updated_at)]
              end
              %>
              <%= content_tag :td,
                display,
                class: class_names(
                  'd-none': column == 'Sort rank', 
                  'text-secondary text-center': column == 'Sort handle'
                ),
                data: {
                  sort: sort
                }
              %>
            <% end  %>
            <td class="column-actions">
              <%= link_to edit_project_tag_path(current_project, tag), remote: true do %>
                <i class="fa-solid fa-pencil"></i> Edit
              <% end %>
              <%= link_to project_tag_path(current_project, tag), method: :delete, data: { confirm: "Are you sure?\n\nProceeding will delete this tag. Any issues with this tag will be untagged." }, class: 'text-error-hover' do %>
                <i class="fa-solid fa-trash"></i> Delete
              <% end %>
            </td>
          </tr>
        <% end %>
      <% end %>
    </tbody>
  </table>
<% end %>
