<% cache ['issues-table', @columns, issues.map(&:id), @issues.map(&:updated_at).map(&:to_i).sort.last] do %>
    <table class="table table-striped mb-0"
      data-behavior="dradis-datatable"
      data-default-columns='["Title", "Created", "Updated"]'
      data-item-name="issue"
      data-local-storage-key="project.ce.issues_datatable"
      data-tags='<%= @tags.map { |t| [t.display_name, t.color, t.name] }.to_json %>'>
      <thead>
        <tr>
          <th class="no-sort" data-column-visible="false"><span class="sr-only">Select</span></th>
          <th class="no-sort" data-column-visible="false"><span class="sr-only">Actions</span></th>
          <% @columns.each do |column| %>
            <th><%= column %></th>
          <% end %>
        </tr>
      </thead>
      <tbody>
        <% issues.each do |issue| %>
        <% cache [issue, @columns, issue.affected_count, 'issues-table'] do %>
        <tr id="issue-<%= issue.id %>" data-tag-url="<%= project_issue_path(current_project, issue) %>">
          <td class="select-checkbox" data-behavior="select-checkbox"></td>
          <td class="column-actions">
            <%= link_to edit_project_issue_path(current_project, issue), title: 'Edit' do %>
              <i class="fa fa-pencil"></i><span class="sr-only">Edit</span>
            <% end %>
            <div class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown"><i class="fa fa-ellipsis-h fa-lg"></i><span class="sr-only">Toggle column actions menu</span></a>
              <div class="dropdown-menu">
                <%= link_to [current_project, issue], method: :delete, data: { confirm: "Are you sure?\n\nProceeding will delete this issue and any associated evidence." }, class: 'text-error-hover dropdown-item' do %>
                  <i class="fa fa-trash fa-fw"></i> Delete
                <% end %>
              </div>
            </div>
          </td>
          <% @columns.each do |column| %>
            <%
             sort, display =
             case column
             when 'Title'
               [issue.title, link_to(issue.title, [current_project, issue])]
             when 'Tags'
               [
                 issue.tags.any? ? issue.tags.first.display_name : '',
                 tag_and_name_for(issue)
               ]
             when 'Affected'
               # this count is coming from the SQL finder in the controller
               [issue.affected_count, issue.affected_count]
             when 'Created'
               [issue.created_at.to_i, local_time_ago(issue.created_at)]
             when 'Created by'
               [issue.author, issue.author]
             when 'Updated'
               [issue.updated_at.to_i, local_time_ago(issue.updated_at)]
             else
               [issue.fields.fetch(column, ''), markup(issue.fields.fetch(column, ''))]
             end
            %>
            <td data-sort="<%= sort %>" <%= 'data-behavior=tag' if column == 'Tags' %> ><%= display %></td>
          <% end  %>
        </tr>
        <% end %>
      <% end %>
    </tbody>
  </table>
<% end %>
