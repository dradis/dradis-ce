#!/usr/bin/env ruby
require 'fileutils'
require 'pathname'

# path to your application root.
APP_ROOT = Pathname.new File.expand_path('../../', __FILE__)

Dir.chdir APP_ROOT do
  # This script is a starting point to setup your application.
  # Add necessary setup steps to this file:
  DRADIS_GITHUB_HANDLE = "https://github.com/dradis"

  # name of dradis plugins, plugins are added by plugin type
  CALCULATOR_ADDONS = ["dradis-calculator_cvss", "dradis-calculator_dread"]
  EXPORT_ADDONS = ["dradis-csv", "dradis-html_export"]
  IMPORT_ADDONS = ["dradis-mediawiki", "dradis-vulndb"]
  UPLOAD_ADDONS = ["dradis-acunetix", "dradis-brakeman", "dradis-burp", "dradis-metasploit",
                   "dradis-nessus", "dradis-nexpose", "dradis-nikto", "dradis-nmap",
                   "dradis-ntospider", "dradis-openvas", "dradis-qualys"]
  OTHER_ADDONS = ["dradis-plugins", "dradis-projects"]

  [CALCULATOR_ADDONS, EXPORT_ADDONS, UPLOAD_ADDONS,
     IMPORT_ADDONS, OTHER_ADDONS].flatten.each do |name|
    addon_dir = File.join(APP_ROOT, '..', name)
    unless Dir.exist?(addon_dir)
      FileUtils.mkdir_p(addon_dir)
      Dir.chdir addon_dir do
        puts "== Cloning #{name} add-on at #{addon_dir} =="
        system "git clone #{DRADIS_GITHUB_HANDLE}/#{name}"
      end
    end
  end


  puts "== Installing dependencies =="
  system "gem install bundler --conservative"
  system "bundle check || bundle install --local"

  puts "\n== Copying sample files =="
  unless File.exist?("Gemfile.plugins")
    system "cp Gemfile.plugins.template Gemfile.plugins"
  end

  unless File.exist?("config/database.yml")
    system "cp config/database.yml.template config/database.yml"
  end

  unless File.exist?("config/secrets.yml")
    system "cp config/secrets.yml.template config/secrets.yml"
  end

  puts "\n== Preparing database =="
  system "bin/rake db:setup"

  puts "\n== Removing old logs and tempfiles =="
  system "rm -f log/*"
  system "rm -rf tmp/cache"

  puts "\n== Restarting application server =="
  system "mkdir -p tmp/"
  system "touch tmp/restart.txt"
end
